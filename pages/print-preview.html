<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Intervention SAV - Aper√ßu</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/images/icon-192.png">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS CORRIG√â -->
<link rel="stylesheet" href="../src/css/main.css">
<link rel="stylesheet" href="../src/css/shared/ui/button.css">
<link rel="stylesheet" href="../src/css/print.css">
</head>
<body>
    <!-- Header uniforme -->
    <div class="app-header no-print">
        <div class="app-header-content">
            <div class="app-header-left">
                <a href="signature-intervenant.html" class="header-back-button">
                    ‚Üê Retour
                </a>
            </div>
            <div class="app-header-center">
                <h1>üìÑ Aper√ßu de la fiche</h1>
                <p>V√©rification avant impression</p>
            </div>
            <div class="app-header-right"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="print-container" id="content">
            <!-- Le contenu sera g√©n√©r√© dynamiquement -->
        </div>
        
        <div class="action-buttons-print no-print">
            <button class="btn-print" onclick="window.print()">
                üñ®Ô∏è Imprimer la fiche
            </button>
            <a href="home.html" class="btn-home">
                üè† Retour √† l'accueil
            </a>
        </div>
    </div>

    <div class="footer no-print">
        <p>Orixis - ¬© 2025</p>
    </div>

    <script>
        // V√©rification d'authentification
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
        
        // Au chargement
        window.addEventListener('load', () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            generatePrintPreview();
        });
        
        // G√©n√©rer l'aper√ßu
        function generatePrintPreview() {
            const data = localStorage.getItem('sav_intervention_complete');
            
            if (!data) {
                document.getElementById('content').innerHTML = `
                    <div class="no-data">
                        <h2>Aucune donn√©e √† afficher</h2>
                        <p>Veuillez d'abord remplir le formulaire d'intervention.</p>
                        <br>
                        <a href="intervention.html">‚Üê Retour au formulaire</a>
                    </div>
                `;
                return;
            }
            
            const intervention = JSON.parse(data);
            const auth = JSON.parse(localStorage.getItem('sav_auth') || '{}');
            
            // G√©n√©rer le contenu HTML
            let html = `
                <div class="fiche-header">
                    <h2>üîß FICHE D'INTERVENTION SAV AUDIO</h2>
                    <p>Contr√¥le / Nettoyage / Maintenance Niveau 1</p>
                </div>
                
                <div class="info-bar">
                    <span><strong>Magasin:</strong> ${auth.magasin || 'Non sp√©cifi√©'}</span>
                    <span><strong>G√©n√©r√© le:</strong> ${new Date().toLocaleString('fr-FR')}</span>
                </div>
                
                <!-- Informations Client -->
                <div class="print-section">
                    <div class="print-section-title">üìã INFORMATIONS CLIENT</div>
                    <div class="date-time-grid">
                        <div class="print-info-row">
                            <span class="print-info-label">Date:</span>
                            <span class="print-info-value">${formatDate(intervention.date)}</span>
                        </div>
                        <div class="print-info-row">
                            <span class="print-info-label">Heure:</span>
                            <span class="print-info-value">${intervention.heure || 'Non sp√©cifi√©'}</span>
                        </div>
                    </div>
                    <div class="print-info-row">
                        <span class="print-info-label">Nom du client:</span>
                        <span class="print-info-value">${intervention.nom || 'Non sp√©cifi√©'}</span>
                    </div>
                    <div class="print-info-row">
                        <span class="print-info-label">T√©l√©phone:</span>
                        <span class="print-info-value">${intervention.telephone || 'Non sp√©cifi√©'}</span>
                    </div>
                </div>
                
                <!-- Type d'appareil -->
                <div class="print-section">
                    <div class="print-section-title">üéß TYPE D'APPAREIL</div>
                    <div class="device-print-grid">
                        <div class="device-print-option ${intervention.type_appareil === 'BTE' ? 'selected' : ''}">
                            BTE Classique
                        </div>
                        <div class="device-print-option ${intervention.type_appareil === 'RIC' ? 'selected' : ''}">
                            RIC/RITE
                        </div>
                        <div class="device-print-option ${intervention.type_appareil === 'ITE' ? 'selected' : ''}">
                            Intra (ITE/CIC)
                        </div>
                    </div>
                    <div class="print-info-row">
                        <span class="print-info-label">Marque:</span>
                        <span class="print-info-value">${intervention.marque || 'Non sp√©cifi√©'}</span>
                    </div>
                </div>
                
                <!-- Probl√®me d√©crit -->
                <div class="print-section">
                    <div class="print-section-title">‚ùì PROBL√àME D√âCRIT</div>
                    <div class="print-checkbox-grid">
                        ${generateCheckboxes(intervention.problemes, [
                            'Pas de son',
                            'Son faible',
                            'Sifflement',
                            'Son intermittent',
                            'Gr√©sille',
                            'Humidit√©',
                            'Inconfort',
                            'Contr√¥le routine'
                        ])}
                    </div>
                </div>
                
                <!-- Actions r√©alis√©es -->
                <div class="print-section">
                    <div class="print-section-title">‚úÖ ACTIONS R√âALIS√âES</div>
                    <div class="print-checkbox-grid">
                        ${generateCheckboxes(intervention.actions, [
                            'Pile chang√©e',
                            'Nettoyage complet',
                            'Filtre chang√©',
                            'D√¥me remplac√©',
                            'Tube chang√©',
                            'S√©chage'
                        ])}
                    </div>
                </div>
                
                <!-- R√©sultat -->
                <div class="print-section">
                    <div class="print-section-title">üìä R√âSULTAT DE L'INTERVENTION</div>
                    <div class="print-info-row">
                        <span class="print-info-label">R√©sultat:</span>
                        <span class="print-info-value">${getResultatText(intervention.resultat)}</span>
                    </div>
                </div>
                
                <!-- Observations -->
                <div class="print-section">
                    <div class="print-section-title">üí¨ OBSERVATIONS</div>
                    <div class="print-text-area">
                        ${intervention.observations || 'Aucune observation particuli√®re'}
                    </div>
                </div>
                
                <!-- Signatures -->
                <div class="signature-print-section">
                    <div class="print-section">
                        <div class="print-section-title">‚úçÔ∏è SIGNATURES</div>
                        <div class="signature-print-grid">
                            <div class="signature-print-box">
                                <span class="signature-print-label">Signature du Client</span>
                                ${intervention.signatureClient ? 
                                    `<img src="${intervention.signatureClient}" class="signature-print-image" alt="Signature client">` : 
                                    '<p style="color: #999; margin-top: 30px;">Non sign√©</p>'
                                }
                            </div>
                            <div class="signature-print-box">
                                <span class="signature-print-label">Signature de l'Intervenant</span>
                                ${intervention.signatureIntervenant ? 
                                    `<img src="${intervention.signatureIntervenant}" class="signature-print-image" alt="Signature intervenant">` : 
                                    '<p style="color: #999; margin-top: 30px;">Non sign√©</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="print-footer">
                    Document g√©n√©r√© le ${new Date().toLocaleString('fr-FR')} - SAV Audio ¬© 2025<br>
                    ${auth.magasin || 'Magasin non sp√©cifi√©'}
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }
        
        // Fonctions utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'Non sp√©cifi√©';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function generateCheckboxes(selected, options) {
            return options.map(option => `
                <div class="print-checkbox-item">
                    <span class="print-checkbox ${selected && selected.includes(option) ? 'checked' : ''}"></span>
                    <span>${option}</span>
                </div>
            `).join('');
        }
        
        function getResultatText(resultat) {
            const resultats = {
                'R√©solu': '‚úÖ Probl√®me r√©solu',
                'Partiel': '‚ö†Ô∏è Am√©lioration partielle',
                'SAV': '‚ùå Sans effet - Escalade SAV',
                'OK': 'üîß Contr√¥le OK'
            };
            return resultats[resultat] || resultat || 'Non sp√©cifi√©';
        }
        
        // Gestion de l'impression
        window.addEventListener('afterprint', function() {
            // Nettoyer les donn√©es apr√®s impression si souhait√©
            if (confirm('Impression termin√©e. Cr√©er une nouvelle intervention ?')) {
                // Nettoyer les donn√©es temporaires
                localStorage.removeItem('sav_intervention_data');
                localStorage.removeItem('sav_client_signature');
                localStorage.removeItem('sav_intervention_complete');
                
                // Rediriger vers la page d'intervention
                window.location.href = 'intervention.html';
            }
        });
    </script>
</body>
</html>
