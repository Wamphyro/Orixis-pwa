<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Compte - SAV Audio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/css/main.css">
    <link rel="stylesheet" href="../src/css/header-layout.css">
    <link rel="stylesheet" href="../src/css/compte.css">
</head>
<body>
    <!-- Header uniforme -->
    <div class="app-header">
        <div class="app-header-content">
            <div class="app-header-left">
                <a href="home.html" class="header-back-button">
                    ‚Üê Retour
                </a>
            </div>
            <div class="app-header-center">
                <h1>üîß Mon Compte</h1>
                <p>Gestion des informations personnelles</p>
            </div>
            <div class="app-header-right"></div>
        </div>
    </div>

    <div class="container">
        <!-- Section Mon Profil (visible pour tous) -->
        <div id="myProfileSection" class="user-cards-container">
            <!-- La carte du profil actuel sera g√©n√©r√©e ici -->
        </div>

        <!-- Section Admin (visible seulement pour les admins) -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <!-- Header avec bouton cr√©ation -->
            <div class="admin-header">
                <h2>üë• Gestion des utilisateurs</h2>
                <button class="btn-primary" onclick="openCreateUserModal()">
                    ‚ûï Cr√©er un nouveau profil
                </button>
            </div>
            
            <!-- Contr√¥les admin -->
            <div class="admin-controls">
                <div class="search-bar">
                    <input type="text" id="searchUser" placeholder="üîç Rechercher un utilisateur..." onkeyup="filterUsers()">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByRole('all')">Tous</button>
                    <button class="filter-btn" onclick="filterByRole('technicien')">üîß Techniciens</button>
                    <button class="filter-btn" onclick="filterByRole('audioprothesiste')">ü¶ª Audioproth√©sistes</button>
                    <button class="filter-btn" onclick="filterByRole('assistant')">üìã Assistants</button>
                    <button class="filter-btn" onclick="filterByRole('manager')">üëî Managers</button>
                    <button class="filter-btn" onclick="filterByRole('admin')">üëë Admins</button>
                </div>
            </div>

            <!-- Liste des utilisateurs -->
            <div id="userCardsContainer" class="user-cards-container">
                <!-- Les cartes seront g√©n√©r√©es dynamiquement -->
            </div>
        </div>

        <!-- Message de chargement -->
        <div id="loadingMessage" class="loading-message">
            <div class="spinner"></div>
            <p>Chargement des informations...</p>
        </div>
    </div>

    <!-- Modal changement de code PIN -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Changer le code PIN</h2>
                <button class="modal-close" onclick="closePinModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="pinChangeForm" onsubmit="handlePinChange(event)">
                    <input type="hidden" id="targetUserId">
                    
                    <div class="form-group" id="oldPinGroup">
                        <label>Code actuel (4 chiffres)</label>
                        <input type="password" id="oldPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Nouveau code (4 chiffres)</label>
                        <input type="password" id="newPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmer le nouveau code</label>
                        <input type="password" id="confirmPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="error-message" id="pinError"></div>
                    <div class="success-message" id="pinSuccess"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closePinModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Valider</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal cr√©ation utilisateur (admin) -->
    <div id="createUserModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>‚ûï Cr√©er un nouveau profil utilisateur</h2>
                <button class="modal-close" onclick="closeCreateUserModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="handleCreateUser(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pr√©nom *</label>
                            <input type="text" id="newUserPrenom" required>
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="newUserNom" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>R√¥le *</label>
                        <select id="newUserRole" required>
                            <option value="">-- S√©lectionner un r√¥le --</option>
                            <option value="technicien">üîß Technicien</option>
                            <option value="audioprothesiste">ü¶ª Audioproth√©siste</option>
                            <option value="assistant">üìã Assistant SAV</option>
                            <option value="manager">üëî Manager</option>
                            <option value="admin">üëë Administrateur</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Code PIN (4 chiffres) *</label>
                        <input type="password" id="newUserPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Magasin par d√©faut</label>
                        <select id="newUserMagasinDefaut">
                            <option value="">-- S√©lectionner --</option>
                            <option value="9DIJ">9DIJ</option>
                            <option value="9AVA">9AVA</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Autorisations magasins</label>
                        <div class="magasins-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" value="9DIJ" name="magasinAuth">
                                <span>9DIJ</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="9AVA" name="magasinAuth">
                                <span>9AVA</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="error-message" id="createUserError"></div>
                    <div class="success-message" id="createUserSuccess"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeCreateUserModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Cr√©er le profil</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initFirebase, chargerTousLesUtilisateurs, getUtilisateurDetails } from '../src/js/services/firebase-auth.js';
        import { CompteService } from '../src/js/services/compte.service.js';
        
        let currentUser = null;
        let allUsers = [];
        let isAdmin = false;
        
        // V√©rification auth
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
        
        // Initialisation
        window.addEventListener('load', async () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            try {
                await initFirebase();
                await loadUserData();
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showError('Erreur de chargement des donn√©es');
            }
        });
        
        // Charger les donn√©es utilisateur
        async function loadUserData() {
            const auth = JSON.parse(localStorage.getItem('sav_auth') || '{}');
            const permissions = JSON.parse(localStorage.getItem('sav_user_permissions') || '{}');
            
            // D√©terminer l'utilisateur actuel
            if (auth.collaborateur && auth.collaborateur.id) {
                currentUser = await getUtilisateurDetails(auth.collaborateur.id);
            }
            
            // Si pas de currentUser, utiliser les donn√©es de l'auth
            if (!currentUser && auth.collaborateur) {
                currentUser = {
                    id: auth.collaborateur.id,
                    nom: auth.collaborateur.nom,
                    prenom: auth.collaborateur.prenom,
                    role: auth.collaborateur.role || 'technicien',
                    autorisations: permissions.autorisations || {}
                };
            }
            
            // V√©rifier si admin
            isAdmin = currentUser?.role === 'admin' || permissions.role === 'admin';
            
            // Afficher la carte du profil actuel avec magasins
            displayCurrentUserCard();
            
            // Afficher les contr√¥les admin si n√©cessaire
            if (isAdmin) {
                document.getElementById('adminSection').style.display = 'block';
                await loadAllUsers();
            }
            
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        // Afficher la carte du profil actuel avec les magasins
        function displayCurrentUserCard() {
            const container = document.getElementById('myProfileSection');
            const auth = JSON.parse(localStorage.getItem('sav_auth') || '{}');
            
            // Cr√©er une carte enrichie pour l'utilisateur actuel
            const userData = {
                ...currentUser,
                magasinActuel: auth.magasin
            };
            
            container.innerHTML = ProfileService.createUserCard(userData, false, true);
        }
        
        // Charger tous les utilisateurs (admin only)
        async function loadAllUsers() {
            try {
                allUsers = await chargerTousLesUtilisateurs();
                displayUserCards(allUsers);
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
            }
        }
        
        // Afficher les cartes utilisateurs
        function displayUserCards(users) {
            const container = document.getElementById('userCardsContainer');
            container.innerHTML = users.map(user => 
                ProfileService.createUserCard(user, true)
            ).join('');
        }
        
        // Fonctions globales pour les √©v√©nements
        window.filterUsers = function() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.nom.toLowerCase().includes(searchTerm) ||
                user.prenom.toLowerCase().includes(searchTerm) ||
                Object.keys(user.autorisations || {}).some(m => m.toLowerCase().includes(searchTerm))
            );
            displayUserCards(filtered);
        }
        
        window.filterByRole = function(role) {
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filtrer
            if (role === 'all') {
                displayUserCards(allUsers);
            } else {
                const filtered = allUsers.filter(user => user.role === role);
                displayUserCards(filtered);
            }
        }
        
        window.changePin = function(userId) {
            document.getElementById('targetUserId').value = userId;
            
            // Si c'est l'utilisateur lui-m√™me ou pas admin, demander l'ancien code
            if (!isAdmin || userId === currentUser?.id) {
                document.getElementById('oldPinGroup').style.display = 'block';
                document.getElementById('oldPin').setAttribute('required', '');
            } else {
                document.getElementById('oldPinGroup').style.display = 'none';
                document.getElementById('oldPin').removeAttribute('required');
            }
            
            document.getElementById('pinModal').classList.add('active');
        }
        
        window.closePinModal = function() {
            document.getElementById('pinModal').classList.remove('active');
            document.getElementById('pinChangeForm').reset();
            document.getElementById('pinError').textContent = '';
            document.getElementById('pinSuccess').textContent = '';
        }
        
        window.handlePinChange = async function(event) {
            event.preventDefault();
            
            const userId = document.getElementById('targetUserId').value;
            const oldPin = document.getElementById('oldPin').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;
            
            // V√©rifications
            if (newPin !== confirmPin) {
                showPinError('Les codes ne correspondent pas');
                return;
            }
            
            if (!/^\d{4}$/.test(newPin)) {
                showPinError('Le code doit contenir exactement 4 chiffres');
                return;
            }
            
            try {
                // V√©rifier l'ancien code si n√©cessaire
                if (document.getElementById('oldPinGroup').style.display !== 'none') {
                    const validOld = await ProfileService.verifyPin(userId, oldPin);
                    if (!validOld) {
                        showPinError('Code actuel incorrect');
                        return;
                    }
                }
                
                // Mettre √† jour le code
                await ProfileService.updatePin(userId, newPin);
                
                showPinSuccess('Code PIN modifi√© avec succ√®s');
                setTimeout(() => closePinModal(), 2000);
                
            } catch (error) {
                showPinError('Erreur lors de la modification du code');
            }
        }
        
        // Fonctions pour cr√©er un utilisateur (admin)
        window.openCreateUserModal = function() {
            document.getElementById('createUserModal').classList.add('active');
        }
        
        window.closeCreateUserModal = function() {
            document.getElementById('createUserModal').classList.remove('active');
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserError').textContent = '';
            document.getElementById('createUserSuccess').textContent = '';
        }
        
        window.handleCreateUser = async function(event) {
            event.preventDefault();
            
            const prenom = document.getElementById('newUserPrenom').value;
            const nom = document.getElementById('newUserNom').value;
            const role = document.getElementById('newUserRole').value;
            const pin = document.getElementById('newUserPin').value;
            const magasinDefaut = document.getElementById('newUserMagasinDefaut').value;
            
            // R√©cup√©rer les magasins autoris√©s
            const magasinsAuth = Array.from(document.querySelectorAll('input[name="magasinAuth"]:checked'))
                .map(cb => cb.value);
            
            if (magasinsAuth.length === 0) {
                showCreateUserError('S√©lectionnez au moins un magasin');
                return;
            }
            
            // Cr√©er l'objet autorisations
            const autorisations = {};
            magasinsAuth.forEach(mag => {
                autorisations[mag] = { acces: true };
            });
            
            // G√©n√©rer un ID unique
            const userId = `${nom.toLowerCase()}${Date.now().toString().slice(-3)}`;
            
            try {
                // Cr√©er le nouveau profil
                await ProfileService.createUser({
                    id: userId,
                    prenom: prenom,
                    nom: nom,
                    role: role,
                    code: pin,
                    actif: true,
                    autorisations: autorisations,
                    magasinParDefaut: magasinDefaut || magasinsAuth[0],
                    dateCreation: new Date().toISOString()
                });
                
                showCreateUserSuccess('Profil cr√©√© avec succ√®s !');
                
                // Recharger la liste
                await loadAllUsers();
                
                setTimeout(() => closeCreateUserModal(), 2000);
                
            } catch (error) {
                console.error('Erreur cr√©ation:', error);
                showCreateUserError('Erreur lors de la cr√©ation du profil');
            }
        }
        
        window.editUser = async function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Activer le mode √©dition
            const card = document.getElementById(`card-${userId}`);
            const fields = card.querySelectorAll('.editable');
            const editBtn = card.querySelector('.btn-edit');
            const saveBtn = card.querySelector('.btn-save');
            
            if (editBtn.style.display !== 'none') {
                // Passer en mode √©dition
                fields.forEach(field => field.contentEditable = true);
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
            }
        }
        
        window.saveUser = async function(userId) {
            const card = document.getElementById(`card-${userId}`);
            const nom = card.querySelector('[data-field="nom"]').textContent;
            const prenom = card.querySelector('[data-field="prenom"]').textContent;
            const roleSelect = card.querySelector('[data-field="role"]');
            const role = roleSelect.value;
            
            try {
                await ProfileService.updateUser(userId, { nom, prenom, role });
                
                // D√©sactiver le mode √©dition
                const fields = card.querySelectorAll('.editable');
                fields.forEach(field => field.contentEditable = false);
                
                card.querySelector('.btn-edit').style.display = 'inline-block';
                card.querySelector('.btn-save').style.display = 'none';
                
                showSuccess('Informations mises √† jour');
            } catch (error) {
                showError('Erreur lors de la sauvegarde');
            }
        }
        
        function showError(message) {
            alert(message);
        }
        
        function showSuccess(message) {
            alert(message);
        }
        
        function showPinError(message) {
            document.getElementById('pinError').textContent = message;
            document.getElementById('pinSuccess').textContent = '';
        }
        
        function showPinSuccess(message) {
            document.getElementById('pinSuccess').textContent = message;
            document.getElementById('pinError').textContent = '';
        }
        
        function showCreateUserError(message) {
            document.getElementById('createUserError').textContent = message;
            document.getElementById('createUserSuccess').textContent = '';
        }
        
        function showCreateUserSuccess(message) {
            document.getElementById('createUserSuccess').textContent = message;
            document.getElementById('createUserError').textContent = '';
        }
    </script>
</body>
</html>
