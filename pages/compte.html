<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Compte - SAV Audio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/css/main.css">
    <link rel="stylesheet" href="../src/css/header-layout.css">
    <link rel="stylesheet" href="../src/css/compte.css">
    <link rel="stylesheet" href="../src/css/gestion-utilisateurs.component.css">
</head>
<body>
    <!-- Header uniforme -->
    <div class="app-header">
        <div class="app-header-content">
            <div class="app-header-left">
                <a href="home.html" class="header-back-button">
                    ‚Üê Retour
                </a>
            </div>
            <div class="app-header-center">
                <h1>üîß Mon Compte</h1>
                <p>Gestion des informations personnelles</p>
            </div>
            <div class="app-header-right"></div>
        </div>
    </div>

    <div class="container">
        <!-- Section informations personnelles -->
        <section class="profile-section">
            <h2>üë§ Mes informations personnelles</h2>
            <div class="user-info-card" id="userInfoCard">
                <!-- Sera rempli dynamiquement -->
            </div>
        </section>

        <!-- Section magasins -->
        <section class="profile-section">
            <h2>üè™ Mes magasins autoris√©s</h2>
            <div class="magasins-grid" id="magasinsGrid">
                <!-- Les vignettes seront g√©n√©r√©es dynamiquement -->
            </div>
        </section>

        <!-- Section admin uniquement -->
        <section id="adminSection" class="profile-section admin-section" style="display: none;">
            <!-- Le composant sera ins√©r√© ici -->
        </section>

        <!-- Message de chargement -->
        <div id="loadingMessage" class="loading-message">
            <div class="spinner"></div>
            <p>Chargement des informations...</p>
        </div>
    </div>

    <!-- Modal changement de code PIN -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Changer le code PIN</h2>
                <button class="modal-close" onclick="closePinModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="pinChangeForm" onsubmit="handlePinChange(event)">
                    <input type="hidden" id="targetUserId">
                    
                    <div class="form-group" id="oldPinGroup">
                        <label>Code actuel (4 chiffres)</label>
                        <input type="password" id="oldPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Nouveau code (4 chiffres)</label>
                        <input type="password" id="newPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmer le nouveau code</label>
                        <input type="password" id="confirmPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="error-message" id="pinError"></div>
                    <div class="success-message" id="pinSuccess"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closePinModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Valider</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initFirebase, chargerTousLesUtilisateurs, getUtilisateurDetails } from '../src/js/services/firebase-auth.js';
        import { CompteService } from '../src/js/services/compte.service.js';
        import { GestionUtilisateursComponent } from '../src/js/components/gestion-utilisateurs.component.js';
        
        let currentUser = null;
        let allUsers = [];
        let isAdmin = false;
        let currentAuth = null;
        
        // V√©rification auth
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            currentAuth = authData;
            return authData.authenticated;
        }
        
        // Initialisation
        window.addEventListener('load', async () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            try {
                await initFirebase();
                await loadUserData();
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showError('Erreur de chargement des donn√©es');
            }
        });
        
        // Charger les donn√©es utilisateur
        async function loadUserData() {
            const permissions = JSON.parse(localStorage.getItem('sav_user_permissions') || '{}');
            
            // D√©terminer l'utilisateur actuel
            if (currentAuth.collaborateur && currentAuth.collaborateur.id) {
                currentUser = await getUtilisateurDetails(currentAuth.collaborateur.id);
            }
            
            // Si pas de currentUser, utiliser les donn√©es de l'auth
            if (!currentUser && currentAuth.collaborateur) {
                currentUser = {
                    id: currentAuth.collaborateur.id,
                    nom: currentAuth.collaborateur.nom,
                    prenom: currentAuth.collaborateur.prenom,
                    role: currentAuth.collaborateur.role || 'technicien',
                    autorisations: permissions.autorisations || {}
                };
            }
            
            // V√©rifier si admin
            isAdmin = currentUser?.role === 'admin' || 
                     currentUser?.role === 'Administrateur' ||
                     permissions.role === 'admin' ||
                     permissions.role === 'Administrateur';
            
            // Afficher les informations personnelles
            displayUserInfo();
            
            // Afficher les magasins
            displayMagasins();
            
            // Afficher la section admin si n√©cessaire
            if (isAdmin) {
                document.getElementById('adminSection').style.display = 'block';
                document.getElementById('adminSection').innerHTML = GestionUtilisateursComponent.render();
                await GestionUtilisateursComponent.init();
            }
            
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        // Afficher les informations personnelles
        function displayUserInfo() {
            const container = document.getElementById('userInfoCard');
            const magasinActuel = currentAuth.magasin;
            
            container.innerHTML = `
                <div class="user-info-content">
                    <div class="user-avatar">
                        ${getInitials(currentUser.prenom, currentUser.nom)}
                    </div>
                    <div class="user-details">
                        <h3>${currentUser.prenom} ${currentUser.nom}</h3>
                        <p class="user-role">${getRoleLabel(currentUser.role)}</p>
                        <p class="user-id">ID: ${currentUser.id}</p>
                        <p class="current-magasin">
                            <strong>Magasin actuel:</strong> 
                            <span class="magasin-badge">${magasinActuel}</span>
                        </p>
                    </div>
                    <div class="user-actions">
                        <button class="btn-primary" onclick="changePin('${currentUser.id}')">
                            üîê Changer mon code PIN
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Afficher les magasins autoris√©s
        function displayMagasins() {
            const container = document.getElementById('magasinsGrid');
            const autorisations = currentUser.autorisations || {};
            
            // R√©cup√©rer les magasins depuis les autorisations
            const magasins = Object.keys(autorisations).filter(mag => autorisations[mag].acces === true);
            
            if (magasins.length === 0) {
                container.innerHTML = '<p class="no-data">Aucun magasin autoris√©</p>';
                return;
            }
            
            container.innerHTML = magasins.map(magasin => {
                const isActive = magasin === currentAuth.magasin;
                const permissions = autorisations[magasin];
                
                return `
                    <div class="magasin-card ${isActive ? 'active' : ''}">
                        <div class="magasin-header">
                            <h4>${magasin}</h4>
                            ${isActive ? '<span class="badge-active">Actif</span>' : ''}
                        </div>
                        <div class="magasin-info">
                            <p><strong>Acc√®s:</strong> ${permissions?.acces ? '‚úÖ Autoris√©' : '‚ùå Refus√©'}</p>
                            ${permissions?.permissions ? 
                                `<p><strong>Permissions:</strong></p>
                                 <ul class="permissions-list">
                                    ${permissions.permissions.map(p => `<li>‚Ä¢ ${p}</li>`).join('')}
                                 </ul>` 
                                : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fonctions utilitaires
        function getInitials(prenom, nom) {
            return `${prenom.charAt(0)}${nom.charAt(0)}`.toUpperCase();
        }
        
        function getRoleLabel(role) {
            const labels = {
                'admin': 'üëë Administrateur',
                'Administrateur': 'üëë Administrateur',
                'manager': 'üëî Manager',
                'audioprothesiste': 'ü¶ª Audioproth√©siste',
                'assistant': 'üìã Assistant SAV',
                'technicien': 'üîß Technicien'
            };
            return labels[role] || role;
        }
        
        // Fonctions globales pour les √©v√©nements du PIN uniquement
        window.changePin = function(userId) {
            document.getElementById('targetUserId').value = userId;
            
            // Si c'est l'utilisateur lui-m√™me ou pas admin, demander l'ancien code
            if (!isAdmin || userId === currentUser?.id) {
                document.getElementById('oldPinGroup').style.display = 'block';
                document.getElementById('oldPin').setAttribute('required', '');
            } else {
                document.getElementById('oldPinGroup').style.display = 'none';
                document.getElementById('oldPin').removeAttribute('required');
            }
            
            document.getElementById('pinModal').classList.add('active');
        }
        
        window.closePinModal = function() {
            document.getElementById('pinModal').classList.remove('active');
            document.getElementById('pinChangeForm').reset();
            document.getElementById('pinError').textContent = '';
            document.getElementById('pinSuccess').textContent = '';
        }
        
        window.handlePinChange = async function(event) {
            event.preventDefault();
            
            const userId = document.getElementById('targetUserId').value;
            const oldPin = document.getElementById('oldPin').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;
            
            // V√©rifications
            if (newPin !== confirmPin) {
                showPinError('Les codes ne correspondent pas');
                return;
            }
            
            if (!/^\d{4}$/.test(newPin)) {
                showPinError('Le code doit contenir exactement 4 chiffres');
                return;
            }
            
            try {
                // V√©rifier l'ancien code si n√©cessaire
                if (document.getElementById('oldPinGroup').style.display !== 'none') {
                    const validOld = await CompteService.verifyPin(userId, oldPin);
                    if (!validOld) {
                        showPinError('Code actuel incorrect');
                        return;
                    }
                }
                
                // Mettre √† jour le code
                await CompteService.updatePin(userId, newPin);
                
                showPinSuccess('Code PIN modifi√© avec succ√®s');
                setTimeout(() => closePinModal(), 2000);
                
            } catch (error) {
                showPinError('Erreur lors de la modification du code');
            }
        }
        
        function showError(message) {
            // Impl√©menter notification d'erreur
            alert(message);
        }
        
        function showSuccess(message) {
            // Impl√©menter notification de succ√®s
            alert(message);
        }
        
        function showPinError(message) {
            document.getElementById('pinError').textContent = message;
            document.getElementById('pinSuccess').textContent = '';
        }
        
        function showPinSuccess(message) {
            document.getElementById('pinSuccess').textContent = message;
            document.getElementById('pinError').textContent = '';
        }
    </script>
</body>
</html>
