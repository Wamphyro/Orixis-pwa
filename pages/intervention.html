<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvelle Intervention - SAV Audio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/images/icon-192.png">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/css/main.css">
    <style>
        /* Styles sp√©cifiques √† la page intervention */
        .intervention-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .form-row > * {
            flex: 1;
            min-width: 200px;
        }
        
        .result-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .btn-continue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-save {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-save:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .warning-box {
            background: #fee;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
            color: #c0392b;
        }
        
        @media (max-width: 768px) {
            .intervention-form {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="home.html" class="back-button">
            ‚Üê Retour
        </a>
        <h1>üìù Nouvelle Intervention</h1>
        <p>Fiche d'intervention SAV Niveau 1</p>
    </div>

    <div class="container">
        <form id="interventionForm" class="intervention-form">
            <!-- Section Client -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üë§</span>
                    <span>Informations Client</span>
                </h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nom">Nom du client*</label>
                        <input type="text" id="nom" name="nom" required placeholder="Nom et pr√©nom">
                    </div>
                    
                    <div class="form-group">
                        <label for="telephone">T√©l√©phone*</label>
                        <input type="tel" id="telephone" name="telephone" required placeholder="06 12 34 56 78">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Date*</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="heure">Heure*</label>
                        <input type="time" id="heure" name="heure" required>
                    </div>
                </div>
            </div>
            
            <!-- Section Appareil -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üéß</span>
                    <span>Type d'Appareil</span>
                </h2>
                
                <div id="device-selector-container"></div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="marque">Marque de l'appareil*</label>
                    <select id="marque" name="marque" required>
                        <option value="">-- S√©lectionnez une marque --</option>
                    </select>
                </div>
            </div>
            
            <!-- Section Probl√®me -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>‚ö†Ô∏è</span>
                    <span>Probl√®me(s) Rencontr√©(s)</span>
                </h2>
                
                <div id="problems-container"></div>
            </div>
            
            <!-- Section Actions -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üîß</span>
                    <span>Action(s) Effectu√©e(s)</span>
                </h2>
                
                <div id="actions-container"></div>
            </div>
            
            <!-- Section R√©sultat -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üìä</span>
                    <span>R√©sultat de l'Intervention</span>
                </h2>
                
                <div class="result-section">
                    <label>R√©sultat*</label>
                    <div id="result-container"></div>
                    
                    <div id="sav-warning" class="warning-box" style="display: none;">
                        ‚ö†Ô∏è Une escalade SAV sera n√©cessaire. Un email sera envoy√© automatiquement √† l'√©quipe technique.
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="observations">Observations compl√©mentaires</label>
                    <textarea id="observations" name="observations" rows="4" placeholder="D√©tails suppl√©mentaires..."></textarea>
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="action-buttons">
                <button type="button" class="btn-save" onclick="saveIntervention()">
                    üíæ Sauvegarder
                </button>
                <button type="submit" class="btn-continue">
                    Continuer vers les signatures ‚Üí
                </button>
            </div>
        </form>
    </div>

    <div class="footer">
        <p>Orixis - ¬© 2025</p>
    </div>

    <script type="module">
        import { DeviceSelector } from '../src/js/components/device-selector.js';
        import { CheckboxGroup } from '../src/js/components/checkbox-group.js';
        import { InterventionService } from '../src/js/services/intervention.service.js';
        import { BRANDS } from '../src/js/data/brands.data.js';
        import { PROBLEMS } from '../src/js/data/problems.data.js';
        import { ACTIONS } from '../src/js/data/actions.data.js';
        import { INTERVENTION_RESULTS } from '../src/js/data/actions.data.js';
        
        // Variables globales
        let deviceSelector;
        let problemsGroup;
        let actionsGroup;
        let resultsGroup;
        
        // V√©rification d'authentification
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
        
        // Initialisation
        window.addEventListener('load', () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            initializeForm();
            loadExistingData();
        });
        
        // Initialiser le formulaire
        function initializeForm() {
            // Date et heure actuelles
            const now = new Date();
            document.getElementById('date').value = now.toISOString().split('T')[0];
            document.getElementById('heure').value = now.toTimeString().slice(0, 5);
            
            // Remplir les marques
            const marqueSelect = document.getElementById('marque');
            BRANDS.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.value;
                option.textContent = brand.label;
                marqueSelect.appendChild(option);
            });
            
            // Initialiser les composants
            deviceSelector = new DeviceSelector('device-selector-container', {
                onChange: (value) => console.log('Device s√©lectionn√©:', value)
            });
            
            problemsGroup = new CheckboxGroup('problems-container', PROBLEMS, {
                columns: 2
            });
            
            actionsGroup = new CheckboxGroup('actions-container', ACTIONS, {
                columns: 2
            });
            
            resultsGroup = new CheckboxGroup('result-container', INTERVENTION_RESULTS, {
                multiple: false,
                columns: 2,
                onChange: (values) => {
                    const savWarning = document.getElementById('sav-warning');
                    savWarning.style.display = values.includes('SAV') ? 'block' : 'none';
                }
            });
        }
        
        // Charger les donn√©es existantes
        function loadExistingData() {
            const intervention = InterventionService.getCurrent();
            if (intervention) {
                // Remplir les champs
                document.getElementById('nom').value = intervention.nom || '';
                document.getElementById('telephone').value = intervention.telephone || '';
                document.getElementById('date').value = intervention.date || '';
                document.getElementById('heure').value = intervention.heure || '';
                document.getElementById('marque').value = intervention.marque || '';
                document.getElementById('observations').value = intervention.observations || '';
                
                // Restaurer les s√©lections
                if (intervention.type_appareil) {
                    deviceSelector.setValue(intervention.type_appareil);
                }
                if (intervention.problemes) {
                    problemsGroup.setValues(intervention.problemes);
                }
                if (intervention.actions) {
                    actionsGroup.setValues(intervention.actions);
                }
                if (intervention.resultat) {
                    resultsGroup.setValues([intervention.resultat]);
                }
            }
        }
        
        // Sauvegarder l'intervention
        window.saveIntervention = function() {
            const formData = collectFormData();
            
            try {
                if (InterventionService.getCurrent()) {
                    InterventionService.update(formData);
                } else {
                    InterventionService.create(formData);
                }
                
                // Feedback visuel
                const btn = document.querySelector('.btn-save');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Sauvegard√© !';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                alert('Erreur lors de la sauvegarde');
            }
        };
        
        // Collecter les donn√©es du formulaire
        function collectFormData() {
            return {
                nom: document.getElementById('nom').value,
                telephone: document.getElementById('telephone').value,
                date: document.getElementById('date').value,
                heure: document.getElementById('heure').value,
                type_appareil: deviceSelector.getValue(),
                marque: document.getElementById('marque').value,
                problemes: problemsGroup.getValues(),
                actions: actionsGroup.getValues(),
                resultat: resultsGroup.getValues()[0],
                observations: document.getElementById('observations').value
            };
        }
        
        // Gestion de la soumission
        document.getElementById('interventionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = collectFormData();
            
            // Validation
            const validation = InterventionService.validate(formData);
            if (!validation.isValid) {
                alert('Veuillez corriger les erreurs:\n' + validation.errors.join('\n'));
                return;
            }
            
            // Sauvegarder ou mettre √† jour
            try {
                if (InterventionService.getCurrent()) {
                    InterventionService.update(formData);
                } else {
                    InterventionService.create(formData);
                }
                
                // Rediriger vers la signature client
                window.location.href = 'signature-client.html';
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la sauvegarde');
            }
        });
    </script>
</body>
</html>
