<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvelle Intervention - SAV Audio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/images/icon-192.png">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/css/main.css">
    <style>
        /* Styles sp√©cifiques √† la page intervention */
        .intervention-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        /* Device selector styles */
        .device-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .device-option {
            cursor: pointer;
            position: relative;
        }
        
        .device-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .device-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .device-option input[type="radio"]:checked + .device-card {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .device-option input[type="radio"]:checked + .device-card.bte {
            border-color: #3498db;
            background: linear-gradient(135deg, #ebf5fb 0%, #d6eaf8 100%);
        }
        
        .device-option input[type="radio"]:checked + .device-card.ric {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fdedec 0%, #fadbd8 100%);
        }
        
        .device-option input[type="radio"]:checked + .device-card.ite {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f8f5 0%, #d5f4e6 100%);
        }
        
        .device-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .device-card h4 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .device-card p {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .device-features {
            text-align: left;
            margin-top: auto;
        }
        
        .feature {
            display: block;
            font-size: 13px;
            color: #666;
            margin: 5px 0;
        }
        
        /* Checkbox group styles */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .checkbox-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .checkbox-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .checkbox-item.checked {
            background: linear-gradient(135deg, #ebf5fb 0%, #d6eaf8 100%);
            border-color: #3498db;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .result-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .btn-continue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-save {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-save:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .warning-box {
            background: #fee;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
            color: #c0392b;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateX(-2px);
        }
        
        @media (max-width: 768px) {
            .intervention-form {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                width: 100%;
            }
            
            .device-selector {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .back-button {
                position: static;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="home.html" class="back-button">
            ‚Üê Retour
        </a>
        <h1>üìù Nouvelle Intervention</h1>
        <p>Fiche d'intervention SAV Niveau 1</p>
    </div>

    <div class="container">
        <form id="interventionForm" class="intervention-form">
            <!-- Section Client -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üë§</span>
                    <span>Informations Client</span>
                </h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nom">Nom du client*</label>
                        <input type="text" id="nom" name="nom" required placeholder="Nom et pr√©nom">
                    </div>
                    
                    <div class="form-group">
                        <label for="telephone">T√©l√©phone*</label>
                        <input type="tel" id="telephone" name="telephone" required placeholder="06 12 34 56 78">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Date*</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="heure">Heure*</label>
                        <input type="time" id="heure" name="heure" required>
                    </div>
                </div>
            </div>
            
            <!-- Section Appareil -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üéß</span>
                    <span>Type d'Appareil</span>
                </h2>
                
                <div class="device-selector">
                    <label class="device-option">
                        <input type="radio" name="type_appareil" value="BTE" required>
                        <div class="device-card bte">
                            <div class="device-icon">üéß</div>
                            <h4>BTE</h4>
                            <p>Contour d'oreille classique</p>
                            <div class="device-features">
                                <span class="feature">‚Ä¢ Pile 13 ou 675</span>
                                <span class="feature">‚Ä¢ Tube + embout</span>
                                <span class="feature">‚Ä¢ Plus puissant</span>
                            </div>
                        </div>
                    </label>
                    
                    <label class="device-option">
                        <input type="radio" name="type_appareil" value="RIC" required>
                        <div class="device-card ric">
                            <div class="device-icon">üîä</div>
                            <h4>RIC/RIE</h4>
                            <p>√âcouteur dans l'oreille</p>
                            <div class="device-features">
                                <span class="feature">‚Ä¢ Pile 10, 312 ou 13</span>
                                <span class="feature">‚Ä¢ √âcouteur + d√¥me</span>
                                <span class="feature">‚Ä¢ Plus discret</span>
                            </div>
                        </div>
                    </label>
                    
                    <label class="device-option">
                        <input type="radio" name="type_appareil" value="ITE" required>
                        <div class="device-card ite">
                            <div class="device-icon">ü¶ª</div>
                            <h4>ITE/ITC/CIC</h4>
                            <p>Intra-auriculaire</p>
                            <div class="device-features">
                                <span class="feature">‚Ä¢ Pile 10 ou 312</span>
                                <span class="feature">‚Ä¢ Sur-mesure</span>
                                <span class="feature">‚Ä¢ Dans l'oreille</span>
                            </div>
                        </div>
                    </label>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="marque">Marque de l'appareil*</label>
                    <select id="marque" name="marque" required>
                        <option value="">-- S√©lectionnez une marque --</option>
                        <option value="Phonak">Phonak</option>
                        <option value="Oticon">Oticon</option>
                        <option value="Signia">Signia/Siemens</option>
                        <option value="Widex">Widex</option>
                        <option value="Starkey">Starkey</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <!-- Section Probl√®me -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>‚ö†Ô∏è</span>
                    <span>Probl√®me(s) Rencontr√©(s)</span>
                </h2>
                
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Pas de son">
                            üîá Pas de son / Muet
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Son faible">
                            üîâ Son faible
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Sifflement">
                            üì¢ Sifflement (Larsen)
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Son intermittent">
                            „Ä∞Ô∏è Son intermittent
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Gr√©sille">
                            üì° Gr√©sille / Parasite
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Humidit√©">
                            üíß Humidit√© / Condensation
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Inconfort">
                            üò£ Inconfort / Douleur
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="problemes" value="Contr√¥le routine">
                            üîß Contr√¥le routine
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Section Actions -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üîß</span>
                    <span>Action(s) Effectu√©e(s)</span>
                </h2>
                
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="Pile chang√©e">
                            üîã Pile test√©e / chang√©e
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="Nettoyage complet">
                            üßπ Nettoyage complet
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="Filtre chang√©">
                            üîÑ Filtre pare-c√©rumen chang√©
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="D√¥me remplac√©">
                            üîµ D√¥me remplac√©
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="Tube chang√©">
                            üìè Tube chang√©
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" name="actions" value="S√©chage">
                            ‚òÄÔ∏è S√©chage effectu√©
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Section R√©sultat -->
            <div class="form-section">
                <h2 class="section-title">
                    <span>üìä</span>
                    <span>R√©sultat de l'Intervention</span>
                </h2>
                
                <div class="result-section">
                    <label>R√©sultat*</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <label>
                                <input type="radio" name="resultat" value="R√©solu" required>
                                ‚úÖ Probl√®me r√©solu
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <label>
                                <input type="radio" name="resultat" value="Partiel" required>
                                ‚ö†Ô∏è Am√©lioration partielle
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <label>
                                <input type="radio" name="resultat" value="SAV" required>
                                ‚ùå Sans effet - Escalade SAV
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <label>
                                <input type="radio" name="resultat" value="OK" required>
                                üîß Contr√¥le OK
                            </label>
                        </div>
                    </div>
                    
                    <div id="sav-warning" class="warning-box" style="display: none;">
                        ‚ö†Ô∏è Une escalade SAV sera n√©cessaire. Un email sera envoy√© automatiquement √† l'√©quipe technique.
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="observations">Observations compl√©mentaires</label>
                    <textarea id="observations" name="observations" rows="4" placeholder="D√©tails suppl√©mentaires..."></textarea>
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="action-buttons">
                <button type="button" class="btn-save" onclick="saveIntervention()">
                    üíæ Sauvegarder
                </button>
                <button type="submit" class="btn-continue">
                    Continuer vers les signatures ‚Üí
                </button>
            </div>
        </form>
    </div>

    <div class="footer">
        <p>Orixis - ¬© 2025</p>
    </div>

    <script>
        // V√©rification d'authentification
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
        
        // Initialisation
        window.addEventListener('load', () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            initializeForm();
            loadExistingData();
        });
        
        // Initialiser le formulaire
        function initializeForm() {
            // Date et heure actuelles
            const now = new Date();
            document.getElementById('date').value = now.toISOString().split('T')[0];
            document.getElementById('heure').value = now.toTimeString().slice(0, 5);
            
            // G√©rer les checkboxes
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox' && e.target.type !== 'radio') {
                        const input = this.querySelector('input');
                        if (input.type === 'checkbox') {
                            input.checked = !input.checked;
                        } else if (input.type === 'radio') {
                            input.checked = true;
                        }
                        input.dispatchEvent(new Event('change'));
                    }
                });
                
                const input = item.querySelector('input');
                input.addEventListener('change', function() {
                    if (this.checked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                    }
                    
                    // G√©rer l'affichage du warning SAV
                    if (this.name === 'resultat' && this.value === 'SAV' && this.checked) {
                        document.getElementById('sav-warning').style.display = 'block';
                    } else if (this.name === 'resultat' && this.value !== 'SAV' && this.checked) {
                        document.getElementById('sav-warning').style.display = 'none';
                    }
                });
            });
        }
        
        // Charger les donn√©es existantes
        function loadExistingData() {
            const savedData = localStorage.getItem('sav_intervention_data');
            if (savedData) {
                const intervention = JSON.parse(savedData);
                
                // Remplir les champs
                if (intervention.nom) document.getElementById('nom').value = intervention.nom;
                if (intervention.telephone) document.getElementById('telephone').value = intervention.telephone;
                if (intervention.date) document.getElementById('date').value = intervention.date;
                if (intervention.heure) document.getElementById('heure').value = intervention.heure;
                if (intervention.marque) document.getElementById('marque').value = intervention.marque;
                if (intervention.observations) document.getElementById('observations').value = intervention.observations;
                
                // Restaurer les s√©lections radio
                if (intervention.type_appareil) {
                    const radio = document.querySelector(`input[name="type_appareil"][value="${intervention.type_appareil}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
                
                if (intervention.resultat) {
                    const radio = document.querySelector(`input[name="resultat"][value="${intervention.resultat}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
                
                // Restaurer les checkboxes
                if (intervention.problemes) {
                    intervention.problemes.forEach(probleme => {
                        const checkbox = document.querySelector(`input[name="problemes"][value="${probleme}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                }
                
                if (intervention.actions) {
                    intervention.actions.forEach(action => {
                        const checkbox = document.querySelector(`input[name="actions"][value="${action}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                }
            }
        }
        
        // Sauvegarder l'intervention
        function saveIntervention() {
            const formData = collectFormData();
            
            // Sauvegarder dans localStorage
            localStorage.setItem('sav_intervention_data', JSON.stringify(formData));
            
            // Feedback visuel
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Sauvegard√© !';
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
        }
        
        // Collecter les donn√©es du formulaire
        function collectFormData() {
            const problemes = [];
            document.querySelectorAll('input[name="problemes"]:checked').forEach(cb => {
                problemes.push(cb.value);
            });
            
            const actions = [];
            document.querySelectorAll('input[name="actions"]:checked').forEach(cb => {
                actions.push(cb.value);
            });
            
            return {
                nom: document.getElementById('nom').value,
                telephone: document.getElementById('telephone').value,
                date: document.getElementById('date').value,
                heure: document.getElementById('heure').value,
                type_appareil: document.querySelector('input[name="type_appareil"]:checked')?.value || '',
                marque: document.getElementById('marque').value,
                problemes: problemes,
                actions: actions,
                resultat: document.querySelector('input[name="resultat"]:checked')?.value || '',
                observations: document.getElementById('observations').value,
                magasin: JSON.parse(localStorage.getItem('sav_auth'))?.magasin || '',
                createdAt: new Date().toISOString()
            };
        }
        
        // Validation du formulaire
        function validateForm() {
            const formData = collectFormData();
            const errors = [];
            
            if (!formData.nom) errors.push('Le nom du client est obligatoire');
            if (!formData.telephone) errors.push('Le t√©l√©phone est obligatoire');
            if (!formData.type_appareil) errors.push('Le type d\'appareil est obligatoire');
            if (!formData.marque) errors.push('La marque est obligatoire');
            if (formData.problemes.length === 0) errors.push('Au moins un probl√®me doit √™tre s√©lectionn√©');
            if (formData.actions.length === 0) errors.push('Au moins une action doit √™tre s√©lectionn√©e');
            if (!formData.resultat) errors.push('Le r√©sultat est obligatoire');
            
            return errors;
        }
        
        // Gestion de la soumission
        document.getElementById('interventionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validation
            const errors = validateForm();
            if (errors.length > 0) {
                alert('Veuillez corriger les erreurs suivantes :\n\n' + errors.join('\n'));
                return;
            }
            
            // Sauvegarder les donn√©es
            saveIntervention();
            
            // Rediriger vers la signature client
            window.location.href = 'signature-client.html';
        });
    </script>
</body>
</html>
