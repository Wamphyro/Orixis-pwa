<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Compte - SAV Audio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/css/main.css">
    <link rel="stylesheet" href="../src/css/header-layout.css">
    <link rel="stylesheet" href="../src/css/profile.css">
</head>
<body>
    <!-- Header uniforme -->
    <div class="app-header">
        <div class="app-header-content">
            <div class="app-header-left">
                <a href="home.html" class="header-back-button">
                    ← Retour
                </a>
            </div>
            <div class="app-header-center">
                <h1>🔧 Mon Compte</h1>
                <p>Gestion des informations personnelles</p>
            </div>
            <div class="app-header-right"></div>
        </div>
    </div>

    <div class="container">
        <!-- Barre de recherche pour admin uniquement -->
        <div id="adminControls" class="admin-controls" style="display: none;">
            <div class="search-bar">
                <input type="text" id="searchUser" placeholder="🔍 Rechercher un utilisateur..." onkeyup="filterUsers()">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByRole('all')">Tous</button>
                <button class="filter-btn" onclick="filterByRole('technicien')">🔧 Techniciens</button>
                <button class="filter-btn" onclick="filterByRole('audioprothesiste')">🦻 Audioprothésistes</button>
                <button class="filter-btn" onclick="filterByRole('assistant')">📋 Assistants</button>
                <button class="filter-btn" onclick="filterByRole('manager')">👔 Managers</button>
                <button class="filter-btn" onclick="filterByRole('admin')">👑 Admins</button>
            </div>
        </div>

        <!-- Conteneur des cartes utilisateur -->
        <div id="userCardsContainer" class="user-cards-container">
            <!-- Les cartes seront générées dynamiquement -->
        </div>

        <!-- Message de chargement -->
        <div id="loadingMessage" class="loading-message">
            <div class="spinner"></div>
            <p>Chargement des informations...</p>
        </div>
    </div>

    <!-- Modal changement de code PIN -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔐 Changer le code PIN</h2>
                <button class="modal-close" onclick="closePinModal()">✕</button>
            </div>
            <div class="modal-body">
                <form id="pinChangeForm" onsubmit="handlePinChange(event)">
                    <input type="hidden" id="targetUserId">
                    
                    <div class="form-group" id="oldPinGroup">
                        <label>Code actuel (4 chiffres)</label>
                        <input type="password" id="oldPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Nouveau code (4 chiffres)</label>
                        <input type="password" id="newPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmer le nouveau code</label>
                        <input type="password" id="confirmPin" pattern="[0-9]{4}" maxlength="4" required>
                    </div>
                    
                    <div class="error-message" id="pinError"></div>
                    <div class="success-message" id="pinSuccess"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closePinModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Valider</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initFirebase, chargerTousLesUtilisateurs, getUtilisateurDetails } from '../src/js/services/firebase-auth.js';
        import { ProfileService } from '../src/js/services/profile.service.js';
        
        let currentUser = null;
        let allUsers = [];
        let isAdmin = false;
        
        // Vérification auth
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
        
        // Initialisation
        window.addEventListener('load', async () => {
            if (!checkAuth()) {
                window.location.href = '../index.html';
                return;
            }
            
            try {
                await initFirebase();
                await loadUserData();
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showError('Erreur de chargement des données');
            }
        });
        
        // Charger les données utilisateur
        async function loadUserData() {
            const auth = JSON.parse(localStorage.getItem('sav_auth') || '{}');
            const permissions = JSON.parse(localStorage.getItem('sav_user_permissions') || '{}');
            
            // Déterminer l'utilisateur actuel
            if (auth.collaborateur && auth.collaborateur.id) {
                currentUser = await getUtilisateurDetails(auth.collaborateur.id);
            }
            
            // Vérifier si admin
            isAdmin = currentUser?.role === 'admin' || permissions.role === 'admin';
            
            // Afficher les contrôles admin si nécessaire
            if (isAdmin) {
                document.getElementById('adminControls').style.display = 'block';
                await loadAllUsers();
            } else {
                displaySingleUserCard(currentUser || {
                    nom: auth.collaborateur?.nom || permissions.nom || 'Utilisateur',
                    prenom: auth.collaborateur?.prenom || permissions.prenom || '',
                    role: permissions.role || 'technicien',
                    magasins: [auth.magasin]
                });
            }
            
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        // Charger tous les utilisateurs (admin only)
        async function loadAllUsers() {
            try {
                allUsers = await chargerTousLesUtilisateurs();
                displayUserCards(allUsers);
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
            }
        }
        
        // Afficher une seule carte (utilisateur normal)
        function displaySingleUserCard(user) {
            const container = document.getElementById('userCardsContainer');
            container.innerHTML = ProfileService.createUserCard(user, false);
        }
        
        // Afficher toutes les cartes (admin)
        function displayUserCards(users) {
            const container = document.getElementById('userCardsContainer');
            container.innerHTML = users.map(user => 
                ProfileService.createUserCard(user, true)
            ).join('');
        }
        
        // Fonctions globales pour les événements
        window.filterUsers = function() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.nom.toLowerCase().includes(searchTerm) ||
                user.prenom.toLowerCase().includes(searchTerm) ||
                user.magasins.some(m => m.toLowerCase().includes(searchTerm))
            );
            displayUserCards(filtered);
        }
        
        window.filterByRole = function(role) {
            // Mettre à jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filtrer
            if (role === 'all') {
                displayUserCards(allUsers);
            } else {
                const filtered = allUsers.filter(user => user.role === role);
                displayUserCards(filtered);
            }
        }
        
        window.editUser = async function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Activer le mode édition
            const card = document.getElementById(`card-${userId}`);
            const fields = card.querySelectorAll('.editable');
            const editBtn = card.querySelector('.btn-edit');
            const saveBtn = card.querySelector('.btn-save');
            
            if (editBtn.style.display !== 'none') {
                // Passer en mode édition
                fields.forEach(field => field.contentEditable = true);
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
            }
        }
        
        window.saveUser = async function(userId) {
            const card = document.getElementById(`card-${userId}`);
            const nom = card.querySelector('[data-field="nom"]').textContent;
            const prenom = card.querySelector('[data-field="prenom"]').textContent;
            const roleSelect = card.querySelector('[data-field="role"]');
            const role = roleSelect.value;
            
            try {
                await ProfileService.updateUser(userId, { nom, prenom, role });
                
                // Désactiver le mode édition
                const fields = card.querySelectorAll('.editable');
                fields.forEach(field => field.contentEditable = false);
                
                card.querySelector('.btn-edit').style.display = 'inline-block';
                card.querySelector('.btn-save').style.display = 'none';
                
                showSuccess('Informations mises à jour');
            } catch (error) {
                showError('Erreur lors de la sauvegarde');
            }
        }
        
        window.changePin = function(userId) {
            document.getElementById('targetUserId').value = userId;
            
            // Si c'est l'utilisateur lui-même ou pas admin, demander l'ancien code
            if (!isAdmin || userId === currentUser?.id) {
                document.getElementById('oldPinGroup').style.display = 'block';
            } else {
                document.getElementById('oldPinGroup').style.display = 'none';
                document.getElementById('oldPin').removeAttribute('required');
            }
            
            document.getElementById('pinModal').classList.add('active');
        }
        
        window.closePinModal = function() {
            document.getElementById('pinModal').classList.remove('active');
            document.getElementById('pinChangeForm').reset();
            document.getElementById('pinError').textContent = '';
            document.getElementById('pinSuccess').textContent = '';
        }
        
        window.handlePinChange = async function(event) {
            event.preventDefault();
            
            const userId = document.getElementById('targetUserId').value;
            const oldPin = document.getElementById('oldPin').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;
            
            // Vérifications
            if (newPin !== confirmPin) {
                showPinError('Les codes ne correspondent pas');
                return;
            }
            
            if (!/^\d{4}$/.test(newPin)) {
                showPinError('Le code doit contenir exactement 4 chiffres');
                return;
            }
            
            try {
                // Vérifier l'ancien code si nécessaire
                if (document.getElementById('oldPinGroup').style.display !== 'none') {
                    const validOld = await ProfileService.verifyPin(userId, oldPin);
                    if (!validOld) {
                        showPinError('Code actuel incorrect');
                        return;
                    }
                }
                
                // Mettre à jour le code
                await ProfileService.updatePin(userId, newPin);
                
                showPinSuccess('Code PIN modifié avec succès');
                setTimeout(() => closePinModal(), 2000);
                
            } catch (error) {
                showPinError('Erreur lors de la modification du code');
            }
        }
        
        function showError(message) {
            // Implémenter notification d'erreur
            alert(message);
        }
        
        function showSuccess(message) {
            // Implémenter notification de succès
            alert(message);
        }
        
        function showPinError(message) {
            document.getElementById('pinError').textContent = message;
            document.getElementById('pinSuccess').textContent = '';
        }
        
        function showPinSuccess(message) {
            document.getElementById('pinSuccess').textContent = message;
            document.getElementById('pinError').textContent = '';
        }
    </script>
</body>
</html>
