<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAV Audio - Connexion</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAV Audio">
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîß</text></svg>">
    
    <!-- CSS - ORDRE IMPORTANT : login.css EN DERNIER pour override -->
    <link rel="stylesheet" href="src/css/main.css">
    <link rel="stylesheet" href="src/css/login.css">
    
    <!-- Fix pour override les conflits -->
    <style>
        /* Override le main.css pour la page login */
        body.login-page {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: center !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        /* Forcer l'affichage du container */
        .login-container {
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Cacher le loading par d√©faut */
        .loading-overlay {
            display: none !important;
        }
        
        .loading-overlay:not(.hidden) {
            display: flex !important;
        }
    </style>
</head>
<body class="login-page">
    <!-- Loading overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner">
            <p>Chargement des donn√©es...</p>
        </div>
    </div>

    <div class="login-container">
        <div class="logo">üîß</div>
        <h1>SAV Audio</h1>
        <p class="subtitle">Connexion s√©curis√©e</p>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="utilisateur">S√©lectionnez votre nom</label>
                <select id="utilisateur" required>
                    <option value="">-- Choisir un utilisateur --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Code d'acc√®s √† 4 chiffres</label>
                <div class="pin-display">
                    <div class="pin-dot" id="pin1"></div>
                    <div class="pin-dot" id="pin2"></div>
                    <div class="pin-dot" id="pin3"></div>
                    <div class="pin-dot" id="pin4"></div>
                </div>
            </div>
            
            <div class="numpad">
                <button type="button" class="numpad-btn" onclick="addDigit(1)">1</button>
                <button type="button" class="numpad-btn" onclick="addDigit(2)">2</button>
                <button type="button" class="numpad-btn" onclick="addDigit(3)">3</button>
                <button type="button" class="numpad-btn" onclick="addDigit(4)">4</button>
                <button type="button" class="numpad-btn" onclick="addDigit(5)">5</button>
                <button type="button" class="numpad-btn" onclick="addDigit(6)">6</button>
                <button type="button" class="numpad-btn" onclick="addDigit(7)">7</button>
                <button type="button" class="numpad-btn" onclick="addDigit(8)">8</button>
                <button type="button" class="numpad-btn" onclick="addDigit(9)">9</button>
                <button type="button" class="numpad-btn delete" onclick="deleteDigit()">‚Üê</button>
                <button type="button" class="numpad-btn zero" onclick="addDigit(0)">0</button>
                <button type="button" class="numpad-btn validate" onclick="validatePin()">‚úì</button>
            </div>
            
            <div class="remember-device">
                <input type="checkbox" id="remember">
                <label for="remember">M√©moriser cet appareil pendant 30 jours</label>
            </div>
            
            <div id="errorMsg" style="display: none;">
                Code incorrect. Veuillez r√©essayer.
            </div>
            
            <div id="successMsg" style="display: none;">
                Connexion r√©ussie ! Redirection...
            </div>
        </form>
        
        <div class="info-box">
            ‚ÑπÔ∏è Contactez votre responsable si vous avez oubli√© votre code
        </div>
    </div>

    <script type="module">
        // Test visuel imm√©diat
        console.log('üé® Page login charg√©e');
        
        // Import Firebase Auth Service
        import { initFirebase, chargerTousLesUtilisateurs, verifierCodePinUtilisateur, getUtilisateurDetails } from './src/js/services/firebase.service.js';
        
        // Variables globales
        let pinCode = '';
        let attempts = 0;
        const MAX_ATTEMPTS = 3;
        let utilisateursData = [];
        
        // Fonctions globales pour le numpad
        window.addDigit = function(digit) {
            if (pinCode.length < 4) {
                pinCode += digit;
                updatePinDisplay();
                
                if (pinCode.length === 4) {
                    setTimeout(validatePin, 200);
                }
            }
        }
        
        window.deleteDigit = function() {
            if (pinCode.length > 0) {
                pinCode = pinCode.slice(0, -1);
                updatePinDisplay();
            }
        }
        
        window.validatePin = validatePin;
        
        // Initialisation au chargement
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÑ DOM pr√™t');
            
            // V√©rifier si d√©j√† connect√©
            if (checkAuth()) {
                window.location.href = 'pages/home.html';
                return;
            }
            
            // Charger tous les utilisateurs
            try {
                showLoading(true);
                
                // Initialiser Firebase
                await initFirebase();
                
                // Charger TOUS les utilisateurs actifs
                utilisateursData = await chargerTousLesUtilisateurs();
                
                if (utilisateursData && utilisateursData.length > 0) {
                    console.log('‚úÖ Utilisateurs charg√©s:', utilisateursData.length);
                    populateUtilisateurs();
                } else {
                    throw new Error('Aucun utilisateur trouv√©');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showError('Erreur de chargement des donn√©es');
            } finally {
                showLoading(false);
            }
        });
        
        // Afficher/cacher le chargement
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                if (show) {
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }
            }
        }
        
        // Remplir le select avec les utilisateurs
        function populateUtilisateurs() {
            const select = document.getElementById('utilisateur');
            select.innerHTML = '<option value="">-- Choisir un utilisateur --</option>';
            
            // Trier par nom/pr√©nom
            const utilisateursSorted = utilisateursData.sort((a, b) => {
                const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            utilisateursSorted.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.prenom} ${user.nom}`;
                option.dataset.magasins = JSON.stringify(user.magasins || []);
                select.appendChild(option);
            });
        }
        
        // Mettre √† jour l'affichage des points
        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin${i}`);
                if (i <= pinCode.length) {
                    dot.textContent = '‚Ä¢';
                    dot.classList.add('filled');
                } else {
                    dot.textContent = '';
                    dot.classList.remove('filled');
                }
            }
        }
        
        // Valider le code PIN
        async function validatePin() {
            if (pinCode.length !== 4) {
                showError('Veuillez entrer un code √† 4 chiffres');
                pinCode = '';
                updatePinDisplay();
                return;
            }
            
            const utilisateurId = document.getElementById('utilisateur').value;
            
            if (!utilisateurId) {
                showError('Veuillez s√©lectionner votre nom');
                pinCode = '';
                updatePinDisplay();
                return;
            }
            
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            
            // Reset messages
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            let isValid = false;
            
            try {
                showLoading(true);
                // V√©rifier le code personnel de l'utilisateur
                isValid = await verifierCodePinUtilisateur(utilisateurId, pinCode);
            } catch (error) {
                console.error('Erreur v√©rification:', error);
                showError('Erreur de v√©rification');
                pinCode = '';
                updatePinDisplay();
                return;
            } finally {
                showLoading(false);
            }
            
            if (isValid) {
                // Connexion r√©ussie
                successMsg.style.display = 'block';
                
                // R√©cup√©rer les infos compl√®tes
                const userData = utilisateursData.find(u => u.id === utilisateurId);
                
                if (userData) {
                    // R√©cup√©rer les d√©tails complets si possible
                    try {
                        const userDetails = await getUtilisateurDetails(utilisateurId);
                        if (userDetails) {
                            // Sauvegarder les permissions et autorisations
                            localStorage.setItem('sav_user_permissions', JSON.stringify({
                                id: userDetails.id,
                                nom: userDetails.nom,
                                prenom: userDetails.prenom,
                                role: userDetails.role || 'technicien',
                                pagesInterdites: userDetails.pagesInterdites || [],
                                autorisations: userDetails.autorisations || {}
                            }));
                        }
                    } catch (error) {
                        console.error('Erreur r√©cup√©ration d√©tails:', error);
                    }
                    
                    // Sauvegarder l'authentification
                    const remember = document.getElementById('remember').checked;
                    const expiry = remember ? 30 * 24 * 60 * 60 * 1000 : 24 * 60 * 60 * 1000;
                    
                    // D√©terminer le magasin par d√©faut
                    let magasinParDefaut = userData.magasinParDefaut || userData.magasins[0];
                    
                    const authData = {
                        authenticated: true,
                        magasin: magasinParDefaut,
                        magasins: userData.magasins || [],
                        timestamp: Date.now(),
                        expiry: expiry,
                        collaborateur: {
                            id: userData.id,
                            prenom: userData.prenom,
                            nom: userData.nom,
                            role: userData.role || 'technicien'
                        }
                    };
                    
                    localStorage.setItem('sav_auth', JSON.stringify(authData));
                    
                    // Redirection
                    setTimeout(() => {
                        window.location.href = 'pages/home.html';
                    }, 1000);
                }
                
            } else {
                // √âchec
                attempts++;
                
                showError(`Code incorrect. ${MAX_ATTEMPTS - attempts} tentatives restantes.`);
                
                if (attempts >= MAX_ATTEMPTS) {
                    showError(`Trop de tentatives. Veuillez attendre ${MAX_ATTEMPTS} minutes.`);
                    disableNumpad(true);
                    setTimeout(() => {
                        attempts = 0;
                        disableNumpad(false);
                    }, MAX_ATTEMPTS * 60 * 1000);
                }
                
                // Reset le code
                pinCode = '';
                updatePinDisplay();
                
                // Animation shake
                const container = document.querySelector('.login-container');
                container.classList.add('shake');
                setTimeout(() => {
                    container.classList.remove('shake');
                }, 500);
            }
        }
        
        // Afficher une erreur
        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            
            // Masquer apr√®s 5 secondes
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }
        
        // Activer/d√©sactiver le clavier
        function disableNumpad(disabled) {
            const buttons = document.querySelectorAll('.numpad-btn');
            buttons.forEach(btn => btn.disabled = disabled);
        }
        
        // Fonction de v√©rification d'authentification
        function checkAuth() {
            const auth = localStorage.getItem('sav_auth');
            if (!auth) return false;
            
            const authData = JSON.parse(auth);
            const now = Date.now();
            
            if (now - authData.timestamp > authData.expiry) {
                localStorage.removeItem('sav_auth');
                return false;
            }
            
            return authData.authenticated;
        }
    </script>
</body>
</html>